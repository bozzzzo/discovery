---
# file: bootstrap/files/bootstrap.yml
#
# Bootstrapping Playbook

- hosts: 127.0.0.1
  connection: local
  become: yes
  vars:
    dwc_config_bucket     : "{{ lookup('file', '/etc/datawire/cloud-metadata/config-bucket') }}"
    dwc_environment       : "{{ lookup('file', '/etc/datawire/cloud-metadata/environment') }}"
    dwc_label             : "{{ lookup('file', '/etc/datawire/cloud-metadata/label') }}"
    dwc_name              : "{{ lookup('file', '/etc/datawire/cloud-metadata/name') }}"
    dwc_secrets_bucket    : "{{ lookup('file', '/etc/datawire/cloud-metadata/secrets-bucket') }}"
    dwc_service_id        : "{{ lookup('file', '/etc/datawire/cloud-metadata/service-id') }}"
  tasks:
  - name: ensure /opt/datawire directory exists
    file:
      path: /opt/datawire
      state: directory
  - name: download configuration from s3
    s3:
      bucket: "{{ dwc_config_bucket }}"
      mode: get
      object: "{{ dwc_name }}/{{ dwc_service_id }}/config.yml"
      dest: /opt/datawire/{{ dwc_service_id }}/config.yml
  - name: download hazelcast configuration from s3
    s3:
      bucket: "{{ dwc_config_bucket }}"
      mode: get
      object: "{{ dwc_name }}/{{ dwc_service_id }}/hazelcast-prod.xml"
      dest: /opt/datawire/{{ dwc_service_id }}/hazelcast-prod.yml
  - name: download java key store from s3
    s3:
      bucket: "{{ dwc_secrets_bucket }}"
      mode: get
      object: "{{ dwc_environment }}/identity/dwc-hmac.jceks"
      dest: /opt/datawire/dwc-hmac.jceks
  - name: configure file permissions
    file:
      path: "{{ item }}"
      mode: 0644
    with_items:
      - /opt/datawire/{{ dwc_service_id }}/config.yml
      - /opt/datawire/dwc-hmac.jceks