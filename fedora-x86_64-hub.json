{
  "variables": {
    "build_number": null,
    "builder": null,
    "commit": null,
    "foundation_ami": null,
    "discovery_version": null
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "name": "discovery-server",

      "ami_description": "Datawire Discovery (build: {{ user `build_number` }})",
      "ami_name": "dwc-discovery-x86_64-hvm-b{{ user `build_number` }}",
      "instance_type": "t2.small",
      "region": "us-east-1",
      "run_tags": {
        "Build": "{{ user `build_number` }}",
        "Builder": "{{ user `builder` }}",
        "Commit": "{{ user `commit` }}",
        "Environment": "dev",
        "Name": "packer-discovery-b{{ user `build_number` }}",
        "Role": "dwc:operations:packer"
      },
      "source_ami": "{{ user `foundation_ami` }}",
      "ssh_username": "fedora",
      "tags": {
        "Build": "{{ user `build_number` }}",
        "Builder": "{{ user `builder` }}",
        "Commit": "{{ user `commit` }}",
        "OS": "fedora",
        "Release": "alpha",
        "Role": "dwc:images:discovery-server"
      }
    },
    {
      "type": "amazon-ebs",
      "name": "discovery-gateway",

      "ami_description": "Datawire Discovery Gateway (build: {{ user `build_number` }})",
      "ami_name": "dwc-discovery-gateway-x86_64-hvm-b{{ user `build_number` }}",
      "instance_type": "t2.small",
      "region": "us-east-1",
      "run_tags": {
        "Build": "{{ user `build_number` }}",
        "Builder": "{{ user `builder` }}",
        "Commit": "{{ user `commit` }}",
        "Environment": "dev",
        "Name": "packer-discovery-gateway-b{{ user `build_number` }}",
        "Role": "dwc:operations:packer"
      },
      "source_ami": "{{ user `foundation_ami` }}",
      "ssh_username": "fedora",
      "tags": {
        "Build": "{{ user `build_number` }}",
        "Builder": "{{ user `builder` }}",
        "Commit": "{{ user `commit` }}",
        "OS": "fedora",
        "Release": "alpha",
        "Role": "dwc:images:discovery-gateway"
      }
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "packer/packages.lst",
      "destination": "/tmp/packages.lst"
    },
    {
      "type": "file",
      "only": ["discovery-server"],

      "source": "discovery-server/build/distributions/discovery-server-{{ user `discovery_version` }}.zip",
      "destination": "/tmp/discovery-server-{{ user `discovery_version` }}.zip"
    },
    {
      "type": "shell",
      "only": ["discovery-server"],

      "script": "{{ template_dir }}/packer/install.sh",
      "execute_command": "echo 'packer' | {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "environment_vars": [
        "PACKAGE_BASE_NAME=discovery-server",
        "PACKAGE_VERSION={{ user `discovery_version` }}",
        "INSTALL_ROOT=/opt/datawire"
      ]
    },
    {
      "type": "file",
      "only": ["discovery-gateway"],

      "source": "discovery-gateway/build/distributions/discovery-gateway-{{ user `discovery_version` }}.zip",
      "destination": "/tmp/discovery-gateway-{{ user `discovery_version` }}.zip"
    },
    {
      "type": "shell",
      "only": ["discovery-gateway"],

      "script": "{{ template_dir }}/packer/install.sh",
      "execute_command": "echo 'packer' | {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "environment_vars": [
        "PACKAGE_BASE_NAME=discovery-gateway",
        "PACKAGE_VERSION={{ user `discovery_version` }}",
        "INSTALL_ROOT=/opt/datawire"
      ]
    }
  ]
}